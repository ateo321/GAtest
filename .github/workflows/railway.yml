name: Railway Auto Deploy

on:
  push:
    branches: [ main ]
  workflow_dispatch:

# Railway token will be accessed directly in steps

jobs:
  test:
    name: Test & Lint
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Run linter
      run: npm run lint
      
    - name: Run tests
      run: npm test

  deploy:
    name: Deploy to Railway
    runs-on: ubuntu-latest
    needs: test
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Install Railway CLI
      run: npm install -g @railway/cli
      
    - name: Check Railway Token
      run: |
        if [ -z "${{ secrets.RAILWAY_TOKEN }}" ]; then
          echo "âš ï¸ RAILWAY_TOKEN not found. Please add it to GitHub Secrets."
          echo "Go to: Settings â†’ Secrets and variables â†’ Actions"
          echo "Add secret: RAILWAY_TOKEN with your Railway token"
          exit 1
        else
          echo "âœ… Railway token found, proceeding with deployment..."
        fi
        
    - name: Deploy to Railway
      run: |
        echo "ðŸš‚ Deploying to Railway..."
        export RAILWAY_TOKEN="${{ secrets.RAILWAY_TOKEN }}"
        railway login
        railway up --detach
        echo "âœ… Deployment completed!"
        
    - name: Get Railway URL
      id: railway-url
      run: |
        echo "ðŸ” Getting Railway deployment URL..."
        RAILWAY_URL=$(railway status --json | jq -r '.deployments[0].url // "https://your-app.railway.app"')
        echo "url=$RAILWAY_URL" >> $GITHUB_OUTPUT
        echo "ðŸŒ Railway URL: $RAILWAY_URL"
        
    - name: Deployment success
      run: |
        echo "## ðŸš‚ Railway Deployment Complete" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Status:** âœ… Successfully deployed to Railway" >> $GITHUB_STEP_SUMMARY
        echo "**Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
        echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
        echo "**Author:** ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
        echo "**Time:** $(date)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸŒ Your app is now live!" >> $GITHUB_STEP_SUMMARY
        echo "**URL:** ${{ steps.railway-url.outputs.url }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ”— Test your deployment:" >> $GITHUB_STEP_SUMMARY
        echo "- Main page: ${{ steps.railway-url.outputs.url }}/" >> $GITHUB_STEP_SUMMARY
        echo "- Health check: ${{ steps.railway-url.outputs.url }}/health" >> $GITHUB_STEP_SUMMARY
        echo "- API: ${{ steps.railway-url.outputs.url }}/api/users" >> $GITHUB_STEP_SUMMARY

  setup-guide:
    name: Railway Setup Guide
    runs-on: ubuntu-latest
    if: false
    
    steps:
    - name: Railway setup guide
      run: |
        echo "## ðŸš‚ Railway Setup Required" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Status:** âš ï¸ Railway token not configured" >> $GITHUB_STEP_SUMMARY
        echo "**Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
        echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
        echo "**Author:** ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ”§ Setup Railway (One-time):" >> $GITHUB_STEP_SUMMARY
        echo "1. Go to [railway.app](https://railway.app)" >> $GITHUB_STEP_SUMMARY
        echo "2. Create new project from GitHub repo" >> $GITHUB_STEP_SUMMARY
        echo "3. Select this repository: ${{ github.repository }}" >> $GITHUB_STEP_SUMMARY
        echo "4. Get Railway token from Account Settings" >> $GITHUB_STEP_SUMMARY
        echo "5. Add `RAILWAY_TOKEN` secret to GitHub" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ”‘ Add GitHub Secret:" >> $GITHUB_STEP_SUMMARY
        echo "1. Go to Repository Settings" >> $GITHUB_STEP_SUMMARY
        echo "2. Secrets and variables â†’ Actions" >> $GITHUB_STEP_SUMMARY
        echo "3. Add `RAILWAY_TOKEN` with your Railway token" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸŒ After setup:" >> $GITHUB_STEP_SUMMARY
        echo "Railway will auto-deploy on every push to main!" >> $GITHUB_STEP_SUMMARY
